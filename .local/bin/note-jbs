#!/usr/bin/env bash

notesDirectory=/data/notes # Default notes path
lastOpenedNote=$(cat "$notesDirectory/utils/lastNoteUsed.txt")

topicNote() {
    noteName=${topicSelected##*/}
    notePath=$notesDirectory/$topicSelected.md

    if [[ ! -f $notePath ]]; then
        echo -e "# $noteName" > "$notePath"
        echo -e "### Note creation $(date +%Y-%m-%d\|%H:%M)" >> "$notePath"
        echo -e "tags" >> "$notePath"
    fi

    nvim -c "norm Go" \
        -c "norm zz" \
        -c "startinsert" "$notePath"
}

generalNote() {
    notesGeneralPath=$notesDirectory/General/note-$(date +%Y-%m-%d).md

    if [[ ! -f $notesGeneralPath ]]; then
        echo -e "# Notes for $(date +%Y-%m-%d)" > "$notesGeneralPath"
        echo -e "" >> "$notesGeneralPath"
    fi

    nvim -c "norm Go" \
        -c "norm Go## $(date +%H:%M:%S)" \
        -c "norm Go" \
        -c "norm zz" \
        -c "startinsert" "$notesGeneralPath"
}

case ${1} in
    -i)
        nvim $notesDirectory/index.md
        ;;
    -o)
        okular "$notesDirectory/$lastOpenedNote.md"
        ;;
    -g)
        unset topicSelected
        generalNote
        ;;
    *)
        topicSelected=$(kdialog --inputbox "Enter the topic and name of the note" "$lastOpenedNote")
        if [[ -z $topicSelected ]];then
            exit
        fi
        echo "$topicSelected" > "$notesDirectory/utils/lastNoteUsed.txt"
        topicNote
        ctags -R $notesDirectory
        ;;
esac
