#!/usr/bin/env bash

if [[ $# -lt 1 || $1 = "-h" ]]; then
        echo -e "Quick notes: note-jbs -f

To view the last note: note-jbs -v

See Index of notes: note-jbs -i

For permanent notes: note-jbs <directory>/<name of note>
    or by search tags note-jbs @1

If you are executing this from krunner, or any other launcher
use: njbs <directory>/<name of note>
    or by search tag njbs @1" && exit
fi

notesDirectory=/data/notes

cd $notesDirectory || exit

redoNotes() {
    find $notesDirectory/ -empty -type f -delete
    find $notesDirectory/ -empty -type d -delete
    ctags -R $notesDirectory
    exa --group-directories-first -T -L 8 -I "utils|tags|index.md|Alchemy" \
        $notesDirectory > $notesDirectory/index.md
}

fleetingNote() {
    notesFleetingPath=$notesDirectory/Fleeting/note-$(date +%Y-%m-%d).md

    if [[ ! -f $notesFleetingPath ]]; then
        echo -e "# Notes for $(date +%Y-%m-%d)" > "$notesFleetingPath"
        echo -e "" >> "$notesFleetingPath"
    fi

    nvim -c "norm Go" \
        -c "norm Go## $(date +%H:%M:%S)" \
        -c "norm Go" \
        -c "norm zz" \
        -c "startinsert" "$notesFleetingPath"
}

tagToNote () {
    if [[ $topicSelected == @* ]]; then
        rg -w -l "## $topicSelected" $notesDirectory
        if [[ $? -eq 0 ]]; then
            findTag=$(rg -w -l "## $topicSelected" $notesDirectory)
            echo "$findTag" > "$notesDirectory/utils/lastNoteUsed"
            nvim "$findTag"
            exit
        else
            notify-send "There's no tag with that number"
            exit
        fi
    fi
}

topicNote() {

    tagToNote

    noteName=${topicSelected##*/}
    directoryNote=${topicSelected//ir/ri}
    notePath=$notesDirectory/$topicSelected.md

    echo "$topicSelected.md" > "$notesDirectory/utils/lastNoteUsed"

    mkdir -p -- "$directoryNote"

    if [[ ! -f $notePath ]]; then
        {
        echo "# $noteName"
        echo "## @"
        echo ""
        echo "### Note creation $(date +%Y-%m-%d\|%H:%M)"
        } > "$notePath"
    fi

    nvim -c "norm Go" \
        -c "norm zz" \
        -c "norm Go" \
        -c "startinsert" "$notePath"
}

case ${1} in
    # Index of notes
    -i)
        redoNotes
        nvim $notesDirectory/index.md ;;

    # Temporary (Fleeting) notes
    -f)
        fleetingNote
        redoNotes ;;

    # Show Luhmann-ID
    -t)
        awk '{print $1}' $notesDirectory/tags | rg "[0-9]" | awk '!x[$0]++' | bat ;;

    # View notes
    -v)
        whichNote=$(cat $notesDirectory/utils/lastNoteUsed)
        okular "$whichNote" ;;

    # Zettelkasten
    *)
        topicSelected="$*"
        topicNote
        redoNotes ;;
esac
