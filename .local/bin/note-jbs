#!/usr/bin/env bash

# Categories
# 0 - Learning
# 1 - Politics, History And Philosophy
# 2 - Computers
# 3 - Linguistics
# 4 - Medicine
# 5 - Psychology

if [[ $# -lt 1 || $1 = "-h" ]]; then
        echo -e "Quick notes: note-jbs -f

To view the last note: note-jbs -v

See Index of notes: note-jbs -i

For permanent notes: note-jbs <directory>/<name of note>
    or by search tags note-jbs @1

If you are executing this from krunner, or any other launcher
use: njbs <directory>/<name of note>
    or by search tag njbs @1" && exit
fi

notesDirectory=/data/notes

cd $notesDirectory || exit

redoNotes() {
    find $notesDirectory/ -empty -type f -delete
    find $notesDirectory/ -empty -type d -delete
    ctags -R $notesDirectory
    exa --group-directories-first -T -L 8 -I "utils|tags|Alchemy" \
        $notesDirectory > $notesDirectory/index.md
}

fleetingNote() {
    notesFleetingPath=$notesDirectory/Fleeting/note-$(date +%Y-%m-%d).md

    if [[ ! -f $notesFleetingPath ]]; then
        echo -e "# Notes for $(date +%Y-%m-%d)" > "$notesFleetingPath"
        echo -e "" >> "$notesFleetingPath"
    fi

    nvim -c "norm Go" \
        -c "norm Go## $(date +%H:%M:%S)" \
        -c "norm Go" \
        -c "norm zz" \
        -c "startinsert" "$notesFleetingPath"
}

luhmannID() {
    if [[ $topicSelected == @* ]]; then

        if rg -w -l "## $topicSelected" $notesDirectory; then
            findTag=$(rg -w -l "## $topicSelected" $notesDirectory)
            echo "$findTag" > "$notesDirectory/utils/lastNoteUsed"
            nvim "$findTag"
            exit
        else
            kdialog --sorry "Theres no tag with that Luhmann-ID" && exit
        fi
    fi
}

topicNote() {

    # If the argument that you give it starts with an at symbol, something
    # like: note-jbs @0 or njbs @0 it will try to open an already existing
    # Luhmann-ID, this is useful to follow the train of thought so that you can
    # open the Zettel in another window.
    luhmannID

    noteName=${topicSelected##*/}
    directoryNote=${topicSelected//ir/ri}
    notePath=$notesDirectory/$topicSelected.md

    echo "$topicSelected.md" > "$notesDirectory/utils/lastNoteUsed"

    mkdir -p -- "$directoryNote"

    if [[ ! -f $notePath ]]; then
        {
        echo "# $noteName"
        echo "## @"
        echo ""
        } > "$notePath"
    fi

    nvim -c "norm Go" \
        -c "norm zz" \
        -c "norm Go" \
        -c "startinsert" "$notePath"
}

case ${1} in
    # Index of notes
    -i)
        redoNotes
        nvim $notesDirectory/index.md ;;

    # Temporary (Fleeting) notes
    -f)
        fleetingNote
        redoNotes ;;

    # Rebuild ctags, clean empty files, and show Luhmann-ID
    -t)
        redoNotes
        awk '{print $1}' $notesDirectory/tags | rg "[0-9]" | awk '!x[$0]++' | bat

        totalNotes=$(awk '{print $1}' $notesDirectory/tags | rg "[0-9]" | awk '!x[$0]++' | wc -l)

        echo -e "Total of notes: \e[33m$totalNotes" ;;

    # View notes
    -v)
        whichNote=$(cat $notesDirectory/utils/lastNoteUsed)
        okular "$whichNote" ;;

    # Zettelkasten
    *)
        topicSelected="$*"
        topicNote
        redoNotes ;;
esac
