#!/usr/bin/env bash

notesDirectory=/data/notes
lastOpenedNote=$(cat "$notesDirectory/utils/lastNoteUsed.txt")

topicNote() {
    noteName=${topicSelected##*/}
    directoryNote=$(echo "$topicSelected" | sed "s/$noteName//g")
    notePath=$notesDirectory/$topicSelected.md

    mkdir -p -- "$directoryNote"

    if [[ ! -f $notePath ]]; then
        echo -e "# $noteName" > "$notePath"
        echo -e "### Note creation $(date +%Y-%m-%d\|%H:%M)" >> "$notePath"
        echo -e "tags" >> "$notePath"
    fi

    nvim -c "norm Go" \
        -c "norm zz" \
        -c "startinsert" "$notePath"
}

fleetingNote() {
    notesFleetingPath=$notesDirectory/Fleeting/note-$(date +%Y-%m-%d).md

    if [[ ! -f $notesFleetingPath ]]; then
        echo -e "# Notes for $(date +%Y-%m-%d)" > "$notesFleetingPath"
        echo -e "" >> "$notesFleetingPath"
    fi

    nvim -c "norm Go" \
        -c "norm Go## $(date +%H:%M:%S)" \
        -c "norm Go" \
        -c "norm zz" \
        -c "startinsert" "$notesFleetingPath"
}

redo_notes() {
    find $notesDirectory/ -empty -type f -delete
    find $notesDirectory/ -empty -type d -delete
    ctags -R $notesDirectory
    ./utils/show-all-notes > index.md
}

case ${1} in
    -f)
        unset topicSelected
        fleetingNote
        redo_notes ;;
    -i)
        nvim $notesDirectory/index.md
        redo_notes ;;
    -k)
        topicSelected="$2"
        echo "$topicSelected" > "$notesDirectory/utils/lastNoteUsed.txt"
        topicNote
        redo_notes ;;
    -o)
        okular "$notesDirectory/$lastOpenedNote.md" ;;
    *)
        topicSelected=$(kdialog --geometry 500x500 --inputbox "Enter the topic and name of the note" "$lastOpenedNote")
        if [[ -z $topicSelected ]];then
            exit
        fi
        echo "$topicSelected" > "$notesDirectory/utils/lastNoteUsed.txt"
        topicNote
        redo_notes ;;
esac
